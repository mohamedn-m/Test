name: Java CI with Maven

on:
  schedule:
    - cron: "30 0 * * *"  # 6:00 AM IST
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Run Specific Test
      run: mvn -Dtest=com.nn.testcase.homepage.HomePageTest test

    - name: Generate and backup .xlsx file
      run: |
        # Assuming the .xlsx file is generated by your Maven build or tests
        GENERATED_XLSX_PATH="target/broken_link_report.xlsx"  # Adjust this based on your project
        BACKUP_DIR="backups"  # Folder to store backups in the repo
        DATE=$(date +'%Y-%m-%d_%H-%M-%S')  # Create a timestamp for the backup file name
        BACKUP_FILE="${BACKUP_DIR}/broken_link_report_${DATE}.xlsx"

        # Ensure backup directory exists
        mkdir -p $BACKUP_DIR
        
        # Copy the generated .xlsx file to the backup folder with a timestamp
        cp $GENERATED_XLSX_PATH $BACKUP_FILE

        # Configure git to commit changes
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # Add the new .xlsx file, commit, and push it to the repository
        git add $BACKUP_FILE
        git commit -m "Backup broken link report: ${DATE}"
        git push origin main  # Change 'main' to your desired branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub token for authentication
